<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Recircle Cup</title>

    <link rel="apple-touch-icon" sizes="57x57" href="/static/apple-icon-57x57.png">
    <link rel="apple-touch-icon" sizes="60x60" href="/static/apple-icon-60x60.png">
    <link rel="apple-touch-icon" sizes="72x72" href="/static/apple-icon-72x72.png">
    <link rel="apple-touch-icon" sizes="76x76" href="/static/apple-icon-76x76.png">
    <link rel="apple-touch-icon" sizes="114x114" href="/static/apple-icon-114x114.png">
    <link rel="apple-touch-icon" sizes="120x120" href="/static/apple-icon-120x120.png">
    <link rel="apple-touch-icon" sizes="144x144" href="/static/apple-icon-144x144.png">
    <link rel="apple-touch-icon" sizes="152x152" href="/static/apple-icon-152x152.png">
    <link rel="apple-touch-icon" sizes="180x180" href="/static/apple-icon-180x180.png">
    <link rel="icon" type="image/png" sizes="192x192"  href="/static/android-icon-192x192.png">
    <link rel="icon" type="image/png" sizes="32x32" href="/static/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="96x96" href="/static/favicon-96x96.png">
    <link rel="icon" type="image/png" sizes="16x16" href="/static/favicon-16x16.png">
    <link rel="manifest" href="/static/manifest.json">
    <meta name="msapplication-TileColor" content="#ffffff">
    <meta name="msapplication-TileImage" content="ms-icon-144x144.png">
    <meta name="theme-color" content="#ffffff">

    <link rel="stylesheet" href="/static/custom.css" media="all">
    <link rel="stylesheet" href="/static/layout.css" media="all and (min-width: 33.236em)">
    <!-- 30em + (1.618em * 2) = 33.236em / Eliminates potential of horizontal scrolling in most cases -->

    <!--[if (lt IE 9) & (!IEMobile)]>
    <link rel="stylesheet" href="/static/layout.css" media="all">
    <![endif]-->
    <link href="https://fonts.googleapis.com/css?family=Karla:400,700|Merriweather+Sans|Raleway" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css?family=Karla:400,700|Merriweather+Sans|Raleway" rel="stylesheet">
    <script src="https://cdn.ravenjs.com/3.26.1/raven.min.js" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/js-cookie@2/src/js.cookie.min.js"></script>
    <script src="/static/url-polyfill.js"></script>

    <!-- Global site tag (gtag.js) - Google Analytics -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=UA-150865052-1"></script>
    <script>
        window.dataLayer = window.dataLayer || [];

        function gtag() {
            dataLayer.push(arguments);
        }

        gtag('js', new Date());

        gtag('config', 'UA-150865052-1');
    </script>
    <script type="text/javascript" src="https://cdn.emailjs.com/dist/email.min.js"></script>
    <script type="text/javascript">
        (function(){
            emailjs.init("user_STIZUXa2EcJZW0JbNzJkK");
        })();
    </script>
    <script src="https://code.jquery.com/jquery-3.3.1.min.js"
            integrity="sha256-FgpCb/KJQlLNfOu91ta32o/NMZxltwRo8QtmkMRdAu8="
            crossorigin="anonymous"></script>
</head>

<body id="container">
<header>
    <nav>
        <div class="logo">
            <a href="/"><img src="/static/logoalt.png"/></a>
        </div>
        <div class="nav">
            <a href="/start">Get started</a>
            <a href="/#blog">Blog</a>
            <a href="/cup-wash">Menstrual Cup Wash</a>
            <div class="user-cart display-inline-block" onclick="window.location = ('/checkout')">
                <img class="user-cart-image" src="static/cart.png"/>
                <span class="user-cart-quantity"></span>
            </div>
        </div>
    </nav>
</header>

<div id="body">

    <section class="emphasis-background">
        <article>
            <form class="order-form margin-bottom-10" onsubmit="event.preventDefault(); sendForm(this)">
            <div class="col1 compact">
                    <div>
                        <div class="font-1p25em font-bold margin-bottom-20">
                            Your Details
                        </div>
                        <div class="margin-bottom-15">
                            <div class="label">Name</div>
                            <input type="text" name="name" title="Name" class="customer-name" required>
                        </div>
                        <div class="margin-bottom-15">
                            <div class="label">Address</div>
                            <input type="text" name="address" title="Address" class="customer-address" required>
                        </div>
                        <div class="margin-bottom-15">
                            <div class="label">City</div>
                            <input type="text" name="city" title="City" class="customer-city" required>
                        </div>
                        <div class="margin-bottom-15">
                            <div class="label">Country</div>
                            <select name="country" title="Country" class="customer-country" onchange="changeCountry()">
                                <option>Australia</option>
                                <option>Bahrain</option>
                                <option>Bangladesh</option>
                                <option>Belgium</option>
                                <option>Canada</option>
                                <option>Czech Republic</option>
                                <option>Denmark</option>
                                <option>Egypt</option>
                                <option>Finland</option>
                                <option>France</option>
                                <option>Germany</option>
                                <option>Hungary</option>
                                <option>Indonesia</option>
                                <option>Iran</option>
                                <option>Italy</option>
                                <option>Japan</option>
                                <option>Kuwait</option>
                                <option>Malaysia</option>
                                <option>New Zealand</option>
                                <option>Oman</option>
                                <option selected>Pakistan</option>
                                <option>Philippines</option>
                                <option>Poland</option>
                                <option>Portugal</option>
                                <option>Qatar</option>
                                <option>Saudi Arabia</option>
                                <option>Singapore</option>
                                <option>Spain</option>
                                <option>Sri Lanka</option>
                                <option>Thailand</option>
                                <option>The Netherlands</option>
                                <option>UAE</option>
                                <option>UK</option>
                                <option>USA</option>
                            </select>
                        </div>
                        <div class="margin-bottom-15">
                            <div class="label">Mobile Number</div>
                            <input type="text" name="mobile-number" title="Mobile Number" class="customer-mobile-number" required>
                        </div>
                        <div class="margin-bottom-15">
                            <div class="label">Email</div>
                            <input type="text" name="email" title="Email" class="customer-email" required>
                        </div>
                        <div class="margin-bottom-15">
                            <div class="label">Comments (optional)</div>
                            <textarea name="comments" title="Comments" class="customer-comments"></textarea>
                        </div>
                    </div>
            </div>
            <div class="col2 compact">
                <div class="margin-bottom-40">
                    <div class="font-1p25em font-bold margin-bottom-20">
                        Your Cart
                    </div>
                    <div class="label">Items</div>
                    <div class="order-items">
                    </div>
                </div>

                <div class="margin-bottom-40">
                    <div class="font-1p25em font-bold margin-bottom-20">
                        Payment Method
                    </div>
                    <div class="margin-bottom-5">
                        <div class="display-inline-block">
                            <input type="radio" id="cash" name="radio-group" checked onclick="showHelp(this)">
                            <label for="cash">Cash on delivery</label>
                        </div>
                        <div class="display-inline-block">
                            <input type="radio" id="transfer" name="radio-group" onclick="showHelp(this)">
                            <label for="transfer" class="margin-left-25">Bank transfer</label>
                        </div>
                        <div class="display-inline-block">
                            <input type="radio" id="card" name="radio-group" onclick="showHelp(this)">
                            <label for="card" class="margin-top-10">Debit/Credit Card</label>
                        </div>
                    </div>
                    <div class="label payment-help margin-top-10">Pay with cash when your order arrives</div>
                </div>

                <div class="margin-bottom-20">
                    <div class="total-price font-bold font-1p25em margin-bottom-5">
                        Total:
                        <span class="font-bold">
                        PKR <span class="price">2000</span><span class="price-discount margin-left-5"></span>
                        </span>
                    </div>
                </div>
                <input type="submit" value="Place Order" class="place-order-button">
            </div>
            </form>
            <div class="clear"></div>
        </article>
    </section>
</div>

<script>
    Raven.config('https://0d9c3b7c58a54182b20a04867fc5c682@sentry.io/1222661').install();

    var countryShippingPrices = {
        "UAE": 1500,
        "USA": 4200,
        "Canada": 4200,
        "Singapore": 2500,
        "UK": 2800,
        "Saudi Arabia": 3200,
        "Australia": 3200,
        "Germany": 3600,
        "France": 3600,
        "Spain": 3600,
        "The Netherlands": 3600,
        "Indonesia": 3200,
        "Philippines": 3500,
        "Belgium": 3600,
        "Italy": 3600,
        "Portugal": 3600,
        "Oman": 3600,
        "Kuwait": 3600,
        "Sri Lanka": 2600,
        "Bangladesh": 2600,
        "Malaysia": 3000,
        "Thailand": 3000,
        "Japan": 5500,
        "New Zealand": 3500,
        "Poland": 3600,
        "Denmark": 3800,
        "Finland": 3800,
        "Hungary": 3600,
        "Czech Republic": 3600,
        "Qatar": 5000,
        "Bahrain": 3600,
        "Iran": 4600,
        "Egypt": 4000
    };

    function getCookie(name) {
        var value = "; " + document.cookie;
        var parts = value.split("; " + name + "=");
        if (parts.length == 2) return parts.pop().split(";").shift();
    }

    // Get parameters
    var url_string = window.location.href;
    var url = new URL(url_string);
    var discount = (url.searchParams.get("discount") == 'true');
    var name = url.searchParams.get("name");
    var email = url.searchParams.get("email");
    var orderNow = url.searchParams.get("orderNow") == 'true';
    if (name && name != 'null') {
        document.querySelector("input[name='name']").value = name
    }
    if (email && email != 'null') {
        document.querySelector("input[name='email']").value = email
    }
    discount = false;

    var outOfStock = false;
    var totalPrice;

    // Get/initialize user cart
    var userCart = (Cookies.getJSON('userCart')) ? Cookies.getJSON('userCart') : [];
    if (orderNow) {
        // Use temp cart for 'Order Now'
        userCart = (Cookies.getJSON('tempCart')) ? Cookies.getJSON('tempCart') : []
    }

    // Check if only donation added to cart, update form
    var onlyDonation = (userCart.length == 1 && userCart[0].name == 'Donated Cup');
    if (onlyDonation) {
        document.querySelector(".customer-address").required = false;
        document.querySelector(".customer-address").parentElement.classList.add('display-none');
        document.querySelector(".customer-city").required = false;
        document.querySelector(".customer-city").parentElement.classList.add('display-none');
        document.querySelector(".customer-mobile-number").required = false;
        document.querySelector(".customer-mobile-number").parentElement.classList.add('display-none');
        document.querySelector(".customer-comments").parentElement.classList.add('display-none');

        document.getElementById("cash").parentElement.classList.add('display-none');
        document.getElementById("transfer").nextElementSibling.classList.remove('margin-left-25');
        document.getElementById("transfer").checked = true;
        showHelp(document.getElementById("transfer"));
    }

    addOrderItems();
    updateTotal();

    function showHelp(element) {
        if (element.id == 'transfer') {
            document.querySelector('.payment-help').innerHTML =
                    'Pay to Recircle Enterprise - 1121-2498-5706-3 - UBL Tufail Road and ' +
                    '<a target="_blank" href="mailto:contact@recircle.life">email</a> or ' +
                    '<a target="_blank" href="https://www.facebook.com/recirclepakistan">message</a>' +
                    ' us a picture of your receipt/transaction.'
        }
        else if (element.id == 'card') {
            document.querySelector('.payment-help').textContent =
                    'Pay online via debit/credit card.'
        }
        else {
            document.querySelector('.payment-help').textContent =
                    'Pay with cash when your order arrives.'
        }
    }

    function sendForm(e) {
        if (userCart.length <= 0) {
            alert('Your cart is empty. Add some items to your cart to place an order.');
            return false;
        }

        document.querySelector('.place-order-button').value = 'Sending...please wait';

        var name = document.querySelector('input[name="name"]').value;
        var address = document.querySelector('input[name="address"]').value;
        var city = document.querySelector('input[name="city"]').value;
        var country = document.querySelector('select[name="country"]').value;
        var mobile = document.querySelector('input[name="mobile-number"]').value;
        var email = document.querySelector('input[name="email"]').value;
        var comments = document.querySelector('textarea[name="comments"]').value;
        var payment = document.querySelector('input[name="radio-group"]:checked').id;
        if (payment == 'transfer') {
            payment = 'bank transfer'
        }

        var data = {
            user_cart: userCart, name: name, address: address, city: city, country: country,
            number: mobile, email: email, comments: comments, payment_type: payment, total: totalPrice
        };

        // Send order to API
        $.ajax({
            type: "POST",
            contentType: "application/json; charset=utf-8",
            crossDomain: false,
            url: 'http://localhost:5000/_add_order',
            data: JSON.stringify({
                data: data
            }),
            success: function (data) {
                // Clear cart if not 'Order Now', redirect to thank you page
                if (!orderNow) {
                    Cookies.set('userCart', [])
                }
                if (payment == 'card') {
                    window.location = data;
                    return false;
                }
                if (onlyDonation) {
                    window.location = '/thankyou-donation';
                }
                else {
                    window.location = '/thankyou';
                }
            },
            dataType: "json"
        });
    }

    function updateTotal() {

        // Get cart items
        var totalCups = 0;
        var totalWashes = 0;
        var totalBoxes = 0;
        var totalDonatedCups = 0;
        userCart.forEach(function(orderItem) {
            if (orderItem.name == 'Small' || orderItem.name == 'Large') {
                totalCups += orderItem.quantity
            }
            if (orderItem.name == 'Wash') {
                totalWashes += orderItem.quantity
            }
            if (orderItem.name == 'Box') {
                totalBoxes += orderItem.quantity
            }
            if (orderItem.name == 'Donated Cup') {
                totalDonatedCups += orderItem.quantity
            }
        });

        // Update total price
        totalPrice = 0;
        if (totalCups >= 2) {
            var sisterCupOffers = Math.floor(totalCups / 2);
            var singleCups = totalCups % 2;
            totalPrice = sisterCupOffers * 4100 + singleCups * 2300;
            if (discount && totalCups) {
                totalPrice *= 0.80;
                totalPrice = Math.round(totalPrice/100)*100;
                document.querySelector(".price-discount").textContent = "(20% Off)";
            }
            else {
                document.querySelector(".price-discount").textContent = "(Save PKR 500 on every 2 Cups)";
            }
        }
        else {
            totalPrice = totalCups * 2300;
            var singleCupDiscount = false;
            if (singleCupDiscount && totalCups) {
                totalPrice *= 0.80;
                totalPrice = Math.round(totalPrice/100)*100;
                document.querySelector(".price-discount").textContent = "(20% Off on Single Cups)";
            }
            else {
                // Add 10% discount on single cup if comfy period box present
                if (totalCups && totalBoxes) {
                    totalPrice *= 0.90;
                    document.querySelector(".price-discount").textContent = "(10% Off on Single Cup)";
                }
                else {
                    document.querySelector(".price-discount").textContent = "";
                }
            }
        }

        if (totalWashes) {
            totalPrice += totalWashes * 900;
        }

        if (totalBoxes) {
            totalPrice += totalBoxes * 2000;
        }

        if (totalDonatedCups) {
            totalPrice += totalDonatedCups * 700;
        }

        // Add delivery cost
        if (userCart.length > 0 && !onlyDonation) {
            totalPrice += getPrice('Delivery')
        }

        document.querySelector(".price").textContent = totalPrice.toLocaleString();
    }

    function addOrderItems() {
        // Add order items from cart
        userCart.forEach(function(orderItem) {
            var orderItemHtml = getOrderItemHtml(orderItem.quantity, orderItem.displayName, getPrice(orderItem.name),
                    orderItem.color, orderItem.dateOfDelivery);
            document.querySelector(".order-items").appendChild(orderItemHtml);
        });
        // Add delivery item
        if (userCart.length > 0 && !onlyDonation) {
            var orderItemHtml = getOrderItemHtml(1, 'Shipping Charge', getPrice('Delivery'), null);
            document.querySelector(".order-items").appendChild(orderItemHtml);
        }
    }

    function getPrice(name) {
        if (name === 'Small' || name === 'Large') {
            return 2300
        }
        if (name === 'Box') {
            return 2000
        }
        if (name === 'Wash') {
            return 900
        }
        if (name === 'Delivery') {
            var country = document.querySelector('select[name="country"]').value;
            if (country && countryShippingPrices[country]) {
                return countryShippingPrices[country];
            }
            return 200
        }
        if (name === 'Donated Cup') {
            return 700
        }
    }

    function getOrderItemHtml(quantity, name, price, color, dateOfDelivery) {
        // Get order item html for this item
        var orderItemPrice = quantity * price;
        var orderItem = document.createElement('div');
        orderItem.classList.add('order-item');
        orderItem.dataset.name = name;
        orderItem.dataset.price = price;
        orderItem.dataset.color = color;
        var itemColor = (color) ? color : '';
        var itemColorHtml = '';
        if (itemColor) {
            itemColorHtml = '<span class="order-item-color-container"> - ' + itemColor + '</span>'
        }

        var itemInfoHtml = '';
        var itemName = name;
        if (name !== 'Shipping Charge') {
            itemInfoHtml += itemColorHtml;
            // Don't show quantity input for comfy period box
            if (name !== 'Comfy Period Box') {
                itemInfoHtml += '<span class="order-item-quantity-container">' + 'x ' +
                    '<input type="number" class="order-item-quantity" onchange="updateOrderItem(this)" min="1" max="10" ' +
                    'value="' + quantity + '">' +
                    '</span>'
            }
            else {
                // Show date of delivery for comfy period box
                var dateOptions = { month: 'short', day: 'numeric' };
                itemInfoHtml += ' <span class="light-grey margin-left-5">' + (new Date(dateOfDelivery).toLocaleDateString("en-US", dateOptions)) + '</span>';
            }
            itemInfoHtml +=
                '<a href="#" class="order-item-remove-container" onclick="removeOrderItem(this);return false;">Remove</a>';
            itemName = 'Recircle ' + itemName
        }

        orderItem.innerHTML =
                itemName +
                itemInfoHtml +
                '<div class="order-item-price">PKR ' + (orderItemPrice).toLocaleString() + '</div>';
        return orderItem;
    }

    // Show/hide cart
    var cartQuantity = userCart.reduce(function (a, b) {
            return a + b.quantity;
    }, 0);
    if (cartQuantity && !orderNow) { // Show if any items in cart and not 'Order Now'
        document.querySelector(".user-cart-quantity").textContent = cartQuantity;
        document.querySelector(".user-cart").classList.remove('display-none');
        document.querySelector(".user-cart").classList.add('display-inline-block');
    }
    else {
        document.querySelector(".user-cart").classList.add('display-none');
        document.querySelector(".user-cart").classList.remove('display-inline-block');
    }

    function removeOrderItem(e) {
        // Get order item index
        var orderItemElement = e.parentNode;
        var orderItems = document.querySelector(".order-items");
        var nodes = Array.prototype.slice.call(orderItems.children);
        var orderItemIndex = nodes.indexOf(orderItemElement);

        // Remove order item, refresh
        if (orderItemIndex > -1) {
            userCart.splice(orderItemIndex, 1);
        }
        if (orderNow) {
            Cookies.set('tempCart', userCart);
            window.location.replace('/checkout?orderNow=true');
        }
        else {
            Cookies.set('userCart', userCart);
            window.location.replace('/checkout');
        }
    }

    function updateOrderItem(e) {
        // Get order item index
        var orderItemElement = e.parentNode.parentNode;
        var orderItems = document.querySelector(".order-items");
        var nodes = Array.prototype.slice.call(orderItems.children);
        var orderItemIndex = nodes.indexOf(orderItemElement);

        // Update quantity
        var quantity = parseInt(e.value);
        var orderItem = userCart[orderItemIndex];
        orderItem.quantity = quantity;

        // Update price
        var orderItemPrice = quantity * parseInt(orderItemElement.dataset.price);
        orderItemElement.querySelector(".order-item-price").textContent = 'PKR ' + (orderItemPrice).toString();
        updateTotal();

        // Update cart
        if (orderNow) {
            Cookies.set('tempCart', userCart);
            window.location.replace('/checkout?orderNow=true');
        }
        else {
            Cookies.set('userCart', userCart);
            window.location.replace('/checkout');
        }
    }

    function changeCountry(e) {
        // Update shipping item and total price
        var orderItemHtml = getOrderItemHtml(1, 'Shipping Charge', getPrice('Delivery'), null);
        var shippingItem = document.querySelector(".order-items").lastElementChild;
        if (shippingItem) {
            shippingItem.replaceWith(orderItemHtml);
        }
        updateTotal();

        // Change payment options
        var country = document.querySelector('select[name="country"]').value;
        if (country != 'Pakistan') {
            document.getElementById("cash").parentElement.classList.add('display-none');
            document.getElementById("transfer").parentElement.classList.add('display-none');
            document.getElementById("card").checked = true;
            showHelp(document.getElementById("card"));
        }
        else {
            document.getElementById("cash").parentElement.classList.remove('display-none');
            document.getElementById("transfer").parentElement.classList.remove('display-none');
        }
    }

</script>
</body>

<div id="footer">
    <a href="mailto:contact@recircle.life">contact@recircle.life</a>
    <p class="center">
        Copyright Recircle Cup 2017 - 2021
    </p>
</div>
</html>